<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRD - Ventas | Bambu CRM V2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles.css">
</head>

<body>
    <button class="mobile-menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">☰ Menú</button>

    <nav id="sidebar">
        <div class="logo"><span>◆</span> Bambu CRM v2</div>
        <div class="nav-group">
            <div class="nav-header">Navegación</div>
            <a href="index.html" class="nav-link">← PRD General</a>
        </div>
        <div class="nav-group">
            <div class="nav-header">En esta página</div>
            <a href="#contexto" class="nav-link">1. Contexto</a>
            <a href="#arquitectura" class="nav-link">2. Arquitectura</a>
            <a href="#vistas" class="nav-link">3. Vistas</a>
            <a href="#filtros" class="nav-link">4. Filtros</a>
            <a href="#acciones" class="nav-link">5. Acciones</a>
            <a href="#pagos" class="nav-link">6. Métodos de Pago</a>
            <a href="#edicion" class="nav-link">7. Edición Post-entrega</a>
            <a href="#calendario" class="nav-link">8. Calendario Semana</a>
            <a href="#exportar" class="nav-link">9. Exportar</a>
            <a href="#auditoria" class="nav-link">10. Auditoría</a>
        </div>
    </nav>

    <main>
        <header>
            <div style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-secondary);">Química Bambu S.R.L.</div>
            <h1>PRD: Módulo Ventas</h1>
            <table>
                <tr><td><strong>Versión</strong></td><td>2.0 (Limpio - Enero 2026)</td></tr>
                <tr><td><strong>Prototipo</strong></td><td><a href="../prototipos/ventas.html">prototipos/ventas.html</a></td></tr>
                <tr><td><strong>Estado</strong></td><td>Prototipo validado</td></tr>
            </table>
            <div class="note" style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 1rem; margin: 1rem 0;">
                <strong>Nota:</strong> Este PRD describe funcionalidades y reglas de negocio. Para referencia visual, ver el prototipo HTML.
            </div>
        </header>

        <!-- CONTEXTO -->
        <section id="contexto">
            <h2>1. Contexto y Propósito</h2>

            <h3>1.1 Descripción</h3>
            <p>Módulo unificado para gestión de TODOS los pedidos post-cotización. Fusiona los conceptos de "Pedidos" e "Histórico" de la v1.</p>

            <h3>1.2 Función principal</h3>
            <p>"Pulir" pedidos post-entrega con los datos reales de lo que se vendió:</p>
            <ul>
                <li>Corregir cantidades entregadas vs planificadas</li>
                <li>Ajustar descuentos olvidados</li>
                <li>Sumar/restar productos por cambios de último momento</li>
                <li>Registrar métodos de pago reales</li>
            </ul>

            <h3>1.3 Cambios clave vs V1</h3>
            <table>
                <tr><th>Aspecto</th><th>V1</th><th>V2</th></tr>
                <tr><td>Estados</td><td>6 estados</td><td>3 estados: Borrador, En tránsito, Entregado</td></tr>
                <tr><td>Edición post-entrega</td><td>No permitido</td><td>Permitido con auditoría</td></tr>
                <tr><td>Método de pago</td><td>No registrado</td><td>Campo obligatorio</td></tr>
                <tr><td>Módulos</td><td>Pedidos + Histórico separados</td><td>Todo en VENTAS</td></tr>
            </table>
        </section>

        <!-- ARQUITECTURA -->
        <section id="arquitectura">
            <h2>2. Arquitectura</h2>

            <h3>2.1 Interacción con otros módulos</h3>
            <table>
                <tr><th>Módulo</th><th>Responsabilidad</th></tr>
                <tr><td><strong>COTIZADOR</strong></td><td>Crear pedidos, asignar fecha, descontar stock, generar cargo CC</td></tr>
                <tr><td><strong>VENTAS</strong></td><td>Ver, editar, cambiar estados, registrar pagos, exportar</td></tr>
                <tr><td><strong>CUENTA CORRIENTE</strong></td><td>Reflejar cargos, pagos y ajustes</td></tr>
            </table>

            <h3>2.2 Flujo de datos</h3>
            <ol>
                <li>COTIZADOR crea pedido → Estado "En tránsito" o "Entregado"</li>
                <li>VENTAS muestra pedido (editable)</li>
                <li>Usuario puede editar, cambiar estado, registrar pago</li>
                <li>Cambios generan ajustes automáticos en CC</li>
            </ol>

            <div class="note" style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 1rem; margin: 1rem 0;">
                <strong>Aclaración crítica:</strong> NO existe módulo "Repartos" separado. El "Calendario de Repartos" es una VISTA dentro de VENTAS.
            </div>
        </section>

        <!-- VISTAS -->
        <section id="vistas">
            <h2>3. Vistas (Tabs)</h2>

            <h3>3.1 Tab: Lista Pedidos</h3>
            <p>Listado principal de todos los pedidos con filtros.</p>
            <p><strong>Columnas:</strong></p>
            <ul>
                <li># Pedido, Fecha entrega, Cliente/Dirección</li>
                <li>Estado (badge), Tipo (badge Fábrica/Reparto)</li>
                <li>Vehículo (si aplica), Monto total</li>
                <li>Método pago (icono), Acciones</li>
            </ul>
            <p><strong>Fila de totales:</strong> Al final, muestra suma de pedidos filtrados, monto total, desglose efectivo/digital.</p>

            <h3>3.2 Tab: Calendario Semana</h3>
            <p>Vista calendario (L-V) con pedidos tipo REPARTO pendientes de entrega.</p>
            <ul>
                <li>Filtro automático: solo pedidos REPARTO no entregados</li>
                <li>Click en día → abre vista detallada con asignación de vehículos</li>
                <li>Permite drag & drop entre vehículos</li>
            </ul>

            <h3>3.3 Tab: Borradores</h3>
            <p>Pedidos guardados sin confirmar desde Cotizador.</p>
            <ul>
                <li>No descuentan stock</li>
                <li>No generan cargo en CC</li>
                <li>Columna "Fecha" = fecha de creación del borrador</li>
            </ul>
        </section>

        <!-- FILTROS -->
        <section id="filtros">
            <h2>4. Filtros Disponibles</h2>

            <table>
                <tr><th>Filtro</th><th>Opciones</th></tr>
                <tr><td>Estado</td><td>En tránsito | Entregado | Todos</td></tr>
                <tr><td>Período</td><td>Desde - Hasta (fechas)</td></tr>
                <tr><td>Tipo</td><td>Fábrica | Reparto | Todos</td></tr>
                <tr><td>Vehículo</td><td>Reparto 1 | Reparto 2 | Sin asignar | Todos</td></tr>
                <tr><td>Método pago</td><td>Efectivo | Digital | Mixto | Sin registrar</td></tr>
                <tr><td>Cliente</td><td>Búsqueda por dirección, incluye "Sin registro"</td></tr>
            </table>
            <p><strong>Todos los filtros son combinables.</strong></p>
        </section>

        <!-- ACCIONES -->
        <section id="acciones">
            <h2>5. Acciones por Pedido</h2>

            <h3>5.1 Ver detalle</h3>
            <p>Modal con información completa: cliente, productos, descuentos, ajustes, total, método pago, historial de cambios.</p>

            <h3>5.2 Editar</h3>
            <p>Abre cotizador en modo edición. Permite modificar productos, cantidades, precios, descuentos.</p>

            <h3>5.3 Cambiar estado</h3>
            <table>
                <tr><th>Transición</th><th>Requisito</th></tr>
                <tr><td>En tránsito → Entregado</td><td>Debe registrar método de pago</td></tr>
                <tr><td>Entregado → En tránsito</td><td>Confirmación (casos de error)</td></tr>
            </table>

            <h3>5.4 Cambiar tipo (REPARTO ↔ FÁBRICA)</h3>
            <ul>
                <li><strong>REPARTO → FÁBRICA:</strong> Estado pasa a "Entregado", se elimina vehículo asignado</li>
                <li><strong>FÁBRICA → REPARTO:</strong> Estado pasa a "En tránsito", abre calendario para seleccionar fecha</li>
            </ul>

            <h3>5.5 Eliminar</h3>
            <p>Con confirmación. Reintegra stock y revierte cargo en CC.</p>
        </section>

        <!-- PAGOS -->
        <section id="pagos">
            <h2>6. Sistema de Pagos</h2>

            <h3>6.1 Opciones de método de pago</h3>
            <ul>
                <li><strong>Efectivo:</strong> Pago en efectivo</li>
                <li><strong>Digital:</strong> MercadoPago, transferencia, débito, crédito</li>
                <li><strong>Mixto:</strong> Combinación de ambos (requiere desglose)</li>
                <li><strong>Sin registrar:</strong> Estado temporal</li>
            </ul>

            <h3>6.2 Pagos parciales</h3>
            <p><strong>Regla:</strong> El monto recibido NO tiene que igualar el total. Se permiten pagos parciales.</p>
            <ul>
                <li>Si monto &lt; total → saldo pendiente en cuenta corriente</li>
                <li>Si monto &gt; total → saldo a favor del cliente</li>
            </ul>

            <h3>6.3 Pagos asociados vs genéricos</h3>
            <table>
                <tr><th>Tipo</th><th>Dónde se registra</th><th>Efecto en pedido</th></tr>
                <tr><td><strong>Asociado</strong></td><td>Cotizador (fábrica) o CC → "Pago a pedido específico"</td><td>Actualiza campo <code>monto_pagado</code></td></tr>
                <tr><td><strong>Genérico</strong></td><td>Cuenta Corriente → "Pago genérico"</td><td>NO actualiza pedido, solo reduce saldo CC</td></tr>
            </table>

            <h3>6.4 Sincronización bidireccional</h3>
            <ul>
                <li>Pago en VENTAS → se crea automáticamente en Cuenta Corriente</li>
                <li>Pago a pedido específico desde CC → actualiza columna "Pagado" en VENTAS</li>
                <li>Anti-duplicados: sistema verifica si ya existe pago antes de crear</li>
            </ul>

            <h3>6.5 Ventas sin cliente ("Sin registro")</h3>
            <ul>
                <li>Cliente ficticio para ventas casuales de mostrador</li>
                <li>Solo modo FÁBRICA</li>
                <li>Pago obligatorio completo (no permite fiado)</li>
                <li>No genera cargo en Cuenta Corriente</li>
            </ul>
        </section>

        <!-- EDICIÓN -->
        <section id="edicion">
            <h2>7. Edición Post-Entrega</h2>

            <h3>7.1 Casos de uso</h3>
            <ul>
                <li>Cliente devolvió producto → restar cantidad</li>
                <li>Se olvidó aplicar descuento → aplicar retroactivo</li>
                <li>Cliente compró extra → sumar productos</li>
                <li>Error en precio → corregir</li>
            </ul>

            <h3>7.2 Impacto automático</h3>
            <p>Al editar un pedido, el sistema automáticamente:</p>
            <ol>
                <li>Ajusta stock (reintegra o descuenta según cambio)</li>
                <li>Recalcula total del pedido</li>
                <li>Genera AJUSTE en cuenta corriente (diferencia entre total anterior y nuevo)</li>
                <li>El cargo original NUNCA se modifica (trazabilidad)</li>
            </ol>

            <h3>7.3 Ejemplo</h3>
            <p>Pedido original: $10.000 (10 unidades). Cliente devolvió 1 unidad.</p>
            <ul>
                <li>Nuevo total: $9.000</li>
                <li>Sistema reintegra 1 unidad al stock</li>
                <li>Crea AJUSTE en CC: -$1.000</li>
                <li>Saldo final cliente: correcto</li>
            </ul>
        </section>

        <!-- CALENDARIO -->
        <section id="calendario">
            <h2>8. Calendario Semana (Vista de Repartos)</h2>

            <h3>8.1 Concepto</h3>
            <p>NO es un módulo separado. Es una vista filtrada dentro de VENTAS que muestra pedidos REPARTO pendientes organizados por día.</p>

            <h3>8.2 Funcionalidades</h3>
            <ul>
                <li>Vista semanal (L-V) con capacidad por día</li>
                <li>Asignación de pedidos a vehículos</li>
                <li>Reordenamiento de pedidos (ruta de entrega)</li>
                <li>Control de capacidad (kg actual vs máximo por vehículo)</li>
            </ul>

            <h3>8.3 Click en día</h3>
            <p>Abre panel con:</p>
            <ul>
                <li>Pedidos por vehículo</li>
                <li>Pedidos sin asignar</li>
                <li>Acciones: mover, reasignar, desasignar</li>
                <li>Link a vista completa</li>
            </ul>

            <h3>8.4 Flujo de pedido REPARTO</h3>
            <ol>
                <li>Cotizador crea pedido → Estado "En tránsito", aparece en calendario</li>
                <li>Usuario asigna a vehículo desde calendario</li>
                <li>Chofer entrega</li>
                <li>Usuario marca como "Entregado" desde Lista Pedidos</li>
                <li>Pedido desaparece del calendario (filtro automático), permanece en VENTAS</li>
            </ol>
        </section>

        <!-- EXPORTAR -->
        <section id="exportar">
            <h2>9. Exportar Reportes</h2>

            <h3>9.1 Exportar Excel</h3>
            <p>Modal con selección de columnas:</p>
            <ul>
                <li><strong>Obligatorias:</strong> # Pedido, Fecha entrega</li>
                <li><strong>Opcionales:</strong> Cliente, Dirección, Teléfono, Tipo, Vehículo, Repartidor, Productos, Subtotal, Descuentos, Ajustes, Total, Método pago, Estado</li>
            </ul>
            <p>El sistema recuerda última selección del usuario.</p>

            <h3>9.2 Exportar hoja de reparto</h3>
            <p>Desde vista de día en calendario:</p>
            <ul>
                <li><strong>Con precios:</strong> Para control interno</li>
                <li><strong>Sin precios:</strong> Para chofer</li>
            </ul>
        </section>

        <!-- AUDITORÍA -->
        <section id="auditoria">
            <h2>10. Auditoría y Trazabilidad</h2>

            <h3>10.1 Historial de cambios</h3>
            <p>Registro automático de todas las modificaciones post-entrega:</p>
            <ul>
                <li>Usuario que editó (nombre + ID)</li>
                <li>Fecha/hora exacta</li>
                <li>Campo modificado</li>
                <li>Valor anterior → Valor nuevo</li>
                <li>IP del usuario</li>
                <li>(Opcional) Razón del cambio</li>
            </ul>

            <h3>10.2 Visualización</h3>
            <p>Línea de tiempo cronológica en el detalle del pedido.</p>

            <h3>10.3 Propósito</h3>
            <ul>
                <li>Trazabilidad total de cambios</li>
                <li>Auditoría fiscal</li>
                <li>Detección de errores o fraudes</li>
            </ul>
        </section>

        <footer>
            <p>Bambu CRM V2 - PRD Ventas | Actualizado: Enero 2026</p>
            <p><a href="index.html">← Volver al PRD General</a></p>
        </footer>
    </main>
</body>

</html>
