<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRD - Cotizador | Bambu CRM V2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles.css">
</head>

<body>
    <button class="mobile-menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">☰ Menú</button>

    <nav id="sidebar">
        <div class="logo">
            <span>◆</span> Bambu CRM v2
        </div>
        <div class="nav-group">
            <div class="nav-header">Navegación</div>
            <a href="index.html" class="nav-link">← PRD General</a>
        </div>
        <div class="nav-group">
            <div class="nav-header">En esta página</div>
            <a href="#contexto" class="nav-link">1. Contexto</a>
            <a href="#modos" class="nav-link">2. Modos Fábrica/Reparto</a>
            <a href="#buscador" class="nav-link">3. Buscador Productos</a>
            <a href="#cliente" class="nav-link">4. Selector Cliente</a>
            <a href="#productos" class="nav-link">5. Lista Productos</a>
            <a href="#descuentos" class="nav-link">6. Descuentos</a>
            <a href="#ajustes" class="nav-link">7. Ajustes y Notas</a>
            <a href="#totales" class="nav-link">8. Totales y Acciones</a>
            <a href="#metodo-pago" class="nav-link">9. Método de Pago</a>
            <a href="#validaciones" class="nav-link">10. Validaciones</a>
            <a href="#estados" class="nav-link">11. Estados</a>
            <a href="#integraciones" class="nav-link">12. Integraciones</a>
        </div>
    </nav>

    <main>
        <header>
            <div style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                Química Bambu S.R.L.
            </div>
            <h1>PRD: Módulo Cotizador</h1>
            <table>
                <tr>
                    <td><strong>Versión</strong></td>
                    <td>2.0 (Limpio - Enero 2026)</td>
                </tr>
                <tr>
                    <td><strong>Prototipo</strong></td>
                    <td><a href="../prototipos/cotizador.html">prototipos/cotizador.html</a></td>
                </tr>
                <tr>
                    <td><strong>Estado</strong></td>
                    <td>Prototipo validado</td>
                </tr>
            </table>
            <div class="note" style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 1rem; margin: 1rem 0;">
                <strong>Nota:</strong> Este PRD describe funcionalidades y reglas de negocio. Para referencia visual, ver el prototipo HTML.
            </div>
        </header>

        <!-- SECCIÓN 1: CONTEXTO -->
        <section id="contexto">
            <h2>1. Contexto y Objetivo</h2>

            <h3>1.1 Descripción</h3>
            <p>El Cotizador es el módulo central para crear pedidos. Optimizado para completar una cotización en ~30 segundos.</p>

            <h3>1.2 Objetivos</h3>
            <ul>
                <li>Reducir tiempo de cotización (de ~2 min a ~30 seg)</li>
                <li>Flujo continuo: al confirmar, vuelve automáticamente a "nueva cotización"</li>
                <li>Navegación eficiente con teclado (atajos: Shift+4, F4)</li>
            </ul>

            <h3>1.3 Acceso</h3>
            <ul>
                <li>Botón "COTIZADOR" en sidebar (siempre visible, destacado en verde)</li>
                <li>Al abrir: colapsa menú lateral para maximizar espacio</li>
            </ul>
        </section>

        <!-- SECCIÓN 2: MODOS -->
        <section id="modos">
            <h2>2. Modos: FÁBRICA vs REPARTO</h2>

            <h3>2.1 Modo FÁBRICA</h3>
            <p><strong>Uso:</strong> Cliente retira producto en el momento</p>
            <table>
                <tr><th>Aspecto</th><th>Comportamiento</th></tr>
                <tr><td>Estado al confirmar</td><td>"Entregado" (directo)</td></tr>
                <tr><td>Stock</td><td>Se descuenta inmediatamente</td></tr>
                <tr><td>Fecha</td><td>Fecha actual (sin calendario)</td></tr>
                <tr><td>Método de pago</td><td>Visible - permite registrar pago en el momento</td></tr>
                <tr><td>Cuenta corriente</td><td>Genera cargo automático si tiene cliente</td></tr>
            </table>

            <h3>2.2 Modo REPARTO</h3>
            <p><strong>Uso:</strong> Pedidos para entrega posterior</p>
            <table>
                <tr><th>Aspecto</th><th>Comportamiento</th></tr>
                <tr><td>Estado al confirmar</td><td>"En tránsito"</td></tr>
                <tr><td>Calendario</td><td>Se abre para elegir fecha (solo L-V)</td></tr>
                <tr><td>Stock</td><td>Se descuenta inmediatamente</td></tr>
                <tr><td>Método de pago</td><td>No visible (se registra al entregar)</td></tr>
                <tr><td>Cuenta corriente</td><td>Genera cargo automático si tiene cliente</td></tr>
            </table>

            <h3>2.3 Cambio de modo</h3>
            <p><strong>Regla:</strong> Cambiar el switch NO reinicia los productos cargados, solo cambia el comportamiento al confirmar.</p>
        </section>

        <!-- SECCIÓN 3: BUSCADOR -->
        <section id="buscador">
            <h2>3. Buscador de Productos</h2>

            <h3>3.1 Comportamiento</h3>
            <ul>
                <li>Auto-focus al abrir cotizador</li>
                <li>Búsqueda predictiva desde 2 caracteres</li>
                <li>Busca por: nombre del producto (case-insensitive)</li>
                <li>Ordenamiento: por campo <code>orden</code> del producto (menor = mayor prioridad)</li>
            </ul>

            <h3>3.2 Información mostrada por resultado</h3>
            <ul>
                <li>Nombre del producto</li>
                <li>Precio (según lista aplicada)</li>
                <li>Stock disponible</li>
            </ul>

            <h3>3.3 Agregar productos</h3>
            <ul>
                <li>Click en resultado → agrega con cantidad 1</li>
                <li>Flechas ↑↓ + Enter → navegar y seleccionar</li>
                <li>Si producto ya está en lista → suma cantidad (no duplica línea)</li>
            </ul>

            <h3>3.4 Productos excluidos</h3>
            <ul>
                <li>NO aparecen: productos con <code>disponible = false</code></li>
                <li>SÍ aparecen con stock 0: productos BAMBU (siempre vendibles)</li>
            </ul>
        </section>

        <!-- SECCIÓN 4: CLIENTE -->
        <section id="cliente">
            <h2>4. Selector de Cliente</h2>

            <h3>4.1 Estado por defecto</h3>
            <p>"Cliente sin nombre" → pedido sin cliente asignado, NO genera cargo en cuenta corriente.</p>

            <h3>4.2 Búsqueda</h3>
            <ul>
                <li>Busca por: dirección (identificador principal en Bambu)</li>
                <li>Muestra: dirección, teléfono, saldo cuenta corriente</li>
            </ul>

            <h3>4.3 Indicadores de saldo</h3>
            <table>
                <tr><th>Saldo</th><th>Color</th><th>Significado</th></tr>
                <tr><td>-$15.000</td><td>Rojo</td><td>Debe $15.000</td></tr>
                <tr><td>$0</td><td>Gris</td><td>Al día</td></tr>
                <tr><td>+$5.000</td><td>Verde</td><td>A favor $5.000</td></tr>
            </table>

            <h3>4.4 Al seleccionar cliente</h3>
            <ul>
                <li>Si tiene descuento fijo configurado → se aplica automáticamente</li>
                <li>Total se recalcula</li>
            </ul>
        </section>

        <!-- SECCIÓN 5: PRODUCTOS -->
        <section id="productos">
            <h2>5. Lista de Productos Agregados</h2>

            <h3>5.1 Columnas</h3>
            <table>
                <tr><th>Columna</th><th>Contenido</th></tr>
                <tr><td>Producto</td><td>Nombre del producto</td></tr>
                <tr><td>Subtotal</td><td>Precio unitario × cantidad</td></tr>
                <tr><td>Unitario</td><td>Precio por unidad (según lista)</td></tr>
                <tr><td>Cantidad</td><td>Botones [-] [número] [+]</td></tr>
                <tr><td>Acciones</td><td>Botón eliminar (sin confirmación)</td></tr>
            </table>

            <h3>5.2 Comportamiento cantidad</h3>
            <ul>
                <li>Botón [-]: si cantidad = 1, se deshabilita (no permite 0)</li>
                <li>Botón [+]: suma 1 sin límite (excepto modo estricto de stock)</li>
                <li>Input central: permite edición directa</li>
            </ul>
        </section>

        <!-- SECCIÓN 6: DESCUENTOS -->
        <section id="descuentos">
            <h2>6. Sistema de Descuentos</h2>

            <h3>6.1 Jerarquía (NO acumulativos)</h3>
            <p><strong>Solo se aplica UNO a la vez, en este orden de prioridad:</strong></p>
            <ol>
                <li><strong>Descuento manual</strong> (input %) - máxima prioridad</li>
                <li><strong>Descuento fijo del cliente</strong> (configurado en perfil)</li>
                <li><strong>Lista de precios</strong> (L1/L2/L3)</li>
            </ol>

            <h3>6.2 Listas de precio</h3>
            <table>
                <tr><th>Lista</th><th>Descuento</th><th>Umbral sugerido</th></tr>
                <tr><td>L1</td><td>0% (base)</td><td>Sin umbral</td></tr>
                <tr><td>L2</td><td>6.25%</td><td>Compras >$250k</td></tr>
                <tr><td>L3</td><td>10%</td><td>Compras >$1M</td></tr>
            </table>
            <p><strong>Nota:</strong> Los umbrales son informativos, no se aplican automáticamente.</p>

            <h3>6.3 Base de cálculo</h3>
            <p><strong>Regla crítica:</strong> Los descuentos se aplican sobre el subtotal MENOS productos en promoción y combos.</p>
            <ul>
                <li>Productos con <code>en_promocion = true</code> ya tienen precio especial</li>
                <li>NO reciben descuento adicional</li>
                <li>Su precio se suma directo al total</li>
            </ul>

            <h3>6.4 Descuento manual</h3>
            <ul>
                <li>Campo numérico: 0-100%</li>
                <li>Permite decimales (5.5%, 12.75%)</li>
                <li>Si > 0: ignora descuento cliente y lista</li>
            </ul>
        </section>

        <!-- SECCIÓN 7: AJUSTES -->
        <section id="ajustes">
            <h2>7. Ajustes y Notas</h2>

            <h3>7.1 Ajuste de monto ($)</h3>
            <p>Campo que permite valores positivos o negativos.</p>
            <table>
                <tr><th>Uso</th><th>Ejemplo</th></tr>
                <tr><td>Cobrar deudas pendientes</td><td>+$5.000</td></tr>
                <tr><td>Devolver dinero a favor</td><td>-$2.000</td></tr>
                <tr><td>Redondeo</td><td>+$15</td></tr>
                <tr><td>Descuento fijo en pesos</td><td>-$500</td></tr>
            </table>

            <h3>7.2 Validación ajuste negativo</h3>
            <p><strong>Regla:</strong> El ajuste negativo NO puede superar el total de la compra.</p>
            <p><strong>Mensaje error:</strong> "El ajuste no puede superar el total ($X)"</p>

            <h3>7.3 Notas del pedido</h3>
            <ul>
                <li>Textarea expandible, máximo 500 caracteres</li>
                <li>Opcional</li>
                <li>Ejemplo: "Cliente pidió entrega antes de las 10am"</li>
            </ul>
        </section>

        <!-- SECCIÓN 8: TOTALES -->
        <section id="totales">
            <h2>8. Totales y Acciones</h2>

            <h3>8.1 Cálculo del total</h3>
            <ol>
                <li>Subtotal = suma(precio_unitario × cantidad)</li>
                <li>Aplicar descuento según jerarquía (solo uno)</li>
                <li>Aplicar ajuste (+/-)</li>
                <li>Validar que total >= 0</li>
            </ol>

            <h3>8.2 Botones de acción</h3>
            <table>
                <tr><th>Botón</th><th>Función</th></tr>
                <tr><td>Generar Resumen</td><td>Vista previa imprimible (no confirma)</td></tr>
                <tr><td>Guardar Borrador</td><td>Guarda sin descontar stock ni generar cargo CC</td></tr>
                <tr><td>Confirmar Pedido</td><td>Confirma según modo (Fábrica/Reparto)</td></tr>
            </table>

            <h3>8.3 Formatos de resumen para compartir</h3>
            <table>
                <tr><th>Formato</th><th>Uso</th></tr>
                <tr><td>WhatsApp</td><td>Texto con emojis, copiar/pegar</td></tr>
                <tr><td>Remito PDF</td><td>Documento formal descargable</td></tr>
            </table>

            <h3>8.4 Atajos de teclado</h3>
            <table>
                <tr><th>Atajo</th><th>Acción</th></tr>
                <tr><td>Shift + 4</td><td>Confirmar Pedido</td></tr>
                <tr><td>F4</td><td>Generar Resumen</td></tr>
            </table>
        </section>

        <!-- SECCIÓN 9: MÉTODO PAGO -->
        <section id="metodo-pago">
            <h2>9. Método de Pago (Solo modo FÁBRICA)</h2>

            <h3>9.1 Visibilidad</h3>
            <p>Solo se muestra cuando switch = FÁBRICA. Permite registrar pago en el momento de la venta.</p>

            <h3>9.2 Opciones</h3>
            <ul>
                <li><strong>Sin marcar:</strong> Pedido sin pago, cliente queda con saldo pendiente</li>
                <li><strong>Efectivo:</strong> Monto se auto-completa con total</li>
                <li><strong>Digital:</strong> Igual que efectivo</li>
                <li><strong>Ambos (mixto):</strong> Dos inputs, suma debe igualar monto recibido</li>
            </ul>

            <h3>9.3 Pago parcial</h3>
            <p><strong>Regla:</strong> El monto recibido NO tiene que igualar el total. Se permite pago parcial.</p>
            <ul>
                <li>Si monto < total → saldo pendiente queda en cuenta corriente</li>
                <li>Si monto > total → saldo a favor del cliente</li>
            </ul>

            <h3>9.4 Concepto importante</h3>
            <p><strong>Pagos "asociados" vs "atados":</strong></p>
            <ul>
                <li>Los pagos en Bambu NO están ATADOS a pedidos específicos</li>
                <li>SÍ pueden registrarse EN EL MOMENTO de crear un pedido</li>
                <li>Reducen el SALDO TOTAL del cliente, no un pedido específico</li>
                <li>Pagos posteriores desde Cuenta Corriente son genéricos</li>
            </ul>
        </section>

        <!-- SECCIÓN 10: VALIDACIONES -->
        <section id="validaciones">
            <h2>10. Validaciones y Reglas de Negocio</h2>

            <h3>10.1 Al confirmar pedido</h3>
            <table>
                <tr><th>Validación</th><th>Mensaje de error</th></tr>
                <tr><td>Debe tener al menos 1 producto</td><td>"Agregá al menos un producto"</td></tr>
                <tr><td>Total no puede ser negativo</td><td>"El total no puede ser negativo"</td></tr>
                <tr><td>Fecha reparto solo L-V</td><td>"Solo días laborables (Lunes a Viernes)"</td></tr>
            </table>

            <h3>10.2 Stock</h3>
            <table>
                <tr><th>Configuración</th><th>Comportamiento</th></tr>
                <tr><td>Modo FLEXIBLE</td><td>Permite agregar aunque stock insuficiente, muestra advertencia</td></tr>
                <tr><td>Modo ESTRICTO</td><td>Bloquea agregado si supera stock disponible</td></tr>
            </table>

            <h3>10.3 Excepción productos BAMBU</h3>
            <p>Productos con <code>proveedor = "BAMBU"</code> siempre se pueden agregar aunque tengan stock 0 o negativo (producción propia).</p>

            <h3>10.4 Cierre con cambios sin guardar</h3>
            <p>Si hay productos cargados y no guardados, muestra confirmación: "¿Estás seguro? Se perderán los cambios no guardados"</p>
        </section>

        <!-- SECCIÓN 11: ESTADOS -->
        <section id="estados">
            <h2>11. Estados y Transiciones</h2>

            <h3>11.1 Estados de pedido</h3>
            <table>
                <tr><th>Estado</th><th>Descripción</th><th>Stock</th><th>Cuenta Corriente</th></tr>
                <tr><td>Borrador</td><td>Guardado sin confirmar</td><td>No descuenta</td><td>No afecta</td></tr>
                <tr><td>En tránsito</td><td>Confirmado, pendiente de entrega</td><td>Descontado</td><td>Cargo generado</td></tr>
                <tr><td>Entregado</td><td>Completado</td><td>Descontado</td><td>Cargo generado</td></tr>
            </table>

            <h3>11.2 Transiciones desde Cotizador</h3>
            <ul>
                <li><strong>Guardar Borrador:</strong> → Estado "Borrador"</li>
                <li><strong>Confirmar (FÁBRICA):</strong> → Estado "Entregado"</li>
                <li><strong>Confirmar (REPARTO):</strong> → Estado "En tránsito"</li>
            </ul>
        </section>

        <!-- SECCIÓN 12: INTEGRACIONES -->
        <section id="integraciones">
            <h2>12. Integraciones con Otros Módulos</h2>

            <h3>12.1 Ventas</h3>
            <ul>
                <li>Pedidos confirmados aparecen en listado</li>
                <li>Borradores se pueden recuperar y editar</li>
                <li>Pedidos REPARTO aparecen en calendario</li>
            </ul>

            <h3>12.2 Cuenta Corriente</h3>
            <ul>
                <li>Al confirmar pedido con cliente → genera cargo automático</li>
                <li>Si se registra pago (modo FÁBRICA) → genera movimiento de pago</li>
            </ul>

            <h3>12.3 Productos</h3>
            <ul>
                <li>Stock se descuenta al confirmar (no al guardar borrador)</li>
                <li>Productos con <code>disponible = false</code> no aparecen en buscador</li>
                <li>Campo <code>orden</code> determina prioridad en resultados</li>
            </ul>

            <h3>12.4 Clientes</h3>
            <ul>
                <li>Descuento fijo del cliente se aplica automáticamente al seleccionarlo</li>
                <li>Saldo se muestra en selector para contexto</li>
            </ul>

            <h3>12.5 Configuración</h3>
            <ul>
                <li>Listas de precio (L1/L2/L3) se configuran en módulo Configuración</li>
                <li>Comportamiento de stock (flexible/estricto) es configurable</li>
            </ul>
        </section>

        <footer>
            <p>Bambu CRM V2 - PRD Cotizador | Actualizado: Enero 2026</p>
            <p><a href="index.html">← Volver al PRD General</a></p>
        </footer>
    </main>
</body>

</html>
